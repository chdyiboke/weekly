# é¡µé¢æ€§èƒ½æŒ‡æ ‡-performance

75%çš„äººæ˜¯è®¤ä¸ºé¡µé¢åŠ è½½æ—¶é•¿æ˜¯ä¸€ä¸ªæ ¸å¿ƒå› ç´ ï¼Œè¿œè¿œé«˜äºå…¶ä»–å½±å“ç”¨æˆ·ä½“éªŒçš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼šç®€æ´æ˜“ç”¨ã€å±å¹•é€‚é…ã€è®¾è®¡å¸å¼•åŠ›ç­‰ç­‰ã€‚


![avatar](img/å‰ç«¯æ€§èƒ½æŒ‡æ ‡.jpg)

æ€§èƒ½å¯¹äºä¸šåŠ¡è€Œè¨€ï¼Œä¹Ÿä¼šç›´æ¥å½±å“åˆ°ç”¨æˆ·ç•™å­˜ã€é¡µé¢è½¬åŒ–å’Œç”¨æˆ·ä½“éªŒç­‰ç­‰æ–¹é¢ã€‚ 

ä¸šç•Œæœ‰è®¸å¤šæ€§èƒ½ç›´æ¥å½±å“ä¸šåŠ¡çš„ä¾‹å­ï¼š

1. Pinterestå‡å°‘é¡µé¢åŠ è½½æ—¶é•¿40%, æé«˜äº†æœç´¢å’Œæ³¨å†Œæ•°15%
2. BBCé¡µé¢åŠ è½½æ—¶é•¿æ¯å¢åŠ 1ç§’ï¼Œç”¨æˆ·æµå¤±10%
3. DoubleClickå‘ç°å¦‚æœç§»åŠ¨ç½‘ç«™åŠ è½½æ—¶é•¿è¶…è¿‡3ç§’ï¼Œ53%çš„ç”¨æˆ·ä¼šæ”¾å¼ƒ


## é‡è¦äº‹ä»¶ï¼šDOMContentLoaded å’Œ onload

DOMContentLoaded: æµè§ˆå™¨å·²å®Œå…¨åŠ è½½ HTMLï¼Œå¹¶æ„å»ºäº† DOM æ ‘ï¼Œä½†åƒ <img> å’Œæ ·å¼è¡¨ä¹‹ç±»çš„å¤–éƒ¨èµ„æºå¯èƒ½å°šæœªåŠ è½½å®Œæˆã€‚
onload: æ•´ä¸ªé¡µé¢ï¼ŒåŒ…æ‹¬æ ·å¼ã€å›¾ç‰‡å’Œå…¶ä»–èµ„æºè¢«åŠ è½½å®Œæˆæ—¶ã€‚onerrorï¼ˆå‡ºç°é”™è¯¯ï¼‰

Q: é—®é¢˜æ¥äº†ï¼Œæ‰§è¡Œ `DOMContentLoaded` çš„æ—¶å€™ï¼Œjsè„šæœ¬æ‰§è¡Œäº†å—ï¼Ÿ  
A: `ä¸ä¸€å®š`ï¼Œonloadäº‹ä»¶ä¹‹åè‚¯å®šè§£æå¥½äº†ã€‚   
deferï¼ˆ4ï¼‰å’Œasyncï¼ˆ5ï¼‰åŠ è½½éƒ½ä¸é˜»å¡é¡µé¢æ¸²æŸ“ï¼Œæœ‰onloadäº‹ä»¶ã€‚  

ä¸åŒç‚¹ï¼š
defer é¡µé¢è§£æå®Œæˆï¼Œæ‰§è¡Œã€‚ä¹‹å DOMContentLoadedäº‹ä»¶ã€‚  
async `å¼‚æ­¥çš„åŠ è½½å’Œæ‰§è¡Œè„šæœ¬`ï¼›jsä¸€æ—¦ä¸‹è½½å¥½äº†å°±ä¼šæ‰§è¡Œï¼Œæ³¨æ„ï¼šå¦‚æœjså‰åæœ‰ä¾èµ–æ€§ï¼Œå°±å¾ˆæœ‰å¯èƒ½å‡ºé”™ã€‚ä¹‹åï¼Œonloadäº‹ä»¶ã€‚

asyncåº”ç”¨ï¼šç‹¬ç«‹çš„ç¬¬ä¸‰æ–¹è„šæœ¬é›†æˆåˆ°é¡µé¢æ—¶ï¼Œæ­¤æ—¶é‡‡ç”¨å¼‚æ­¥åŠ è½½æ–¹å¼æ˜¯éå¸¸æ£’çš„ï¼šè®¡æ•°å™¨ï¼Œå¹¿å‘Šç­‰ã€‚


## å¸¸è§webæ€§èƒ½æŒ‡æ ‡- Chrome
DOMContentLoaded æˆ– Load è¿™æ ·çš„åº¦é‡å¹¶ä¸èƒ½åæ˜ ç”¨æˆ·çš„è§†è§‰ä½“éªŒï¼Œå› ä¸ºå®ƒä»¬çš„æ—¶é—´ç‚¹ä¸ä¸€å®šä¸ç”¨æˆ·åœ¨å±å¹•ä¸Šçœ‹åˆ°å†…å®¹çš„æ—¶é—´ç‚¹å¯¹åº”ã€‚
First Paint å’Œ First Contentful Paint è¿™äº›ä»¥ç”¨æˆ·ä¸ºä¸­å¿ƒçš„æ€§èƒ½æŒ‡æ ‡å…³æ³¨çš„æ˜¯åˆå§‹ç»˜åˆ¶æ—¶é—´ï¼Œå¯ä»¥ç”¨æ¥è¡¡é‡é¡µé¢çš„`ç™½å±æ—¶é—´`ã€‚
![avatar](img/æ€§èƒ½æŒ‡æ ‡.jpg)
|FP|FCP|LCP|DCL|L|  
| :-----| :---- | :---- | :---- | :---- |
|First Paint|First Contentful Paint|Largest Contentful Paint|DomContentLoaded|Load|
|é¦–æ¬¡ç»˜åˆ¶åƒç´ |æµè§ˆå™¨é¦–æ¬¡ç»˜åˆ¶æ¥è‡ª DOM çš„å†…å®¹|å¯è§†åŒºåŸŸä¸­æœ€å¤§çš„å†…å®¹å…ƒç´ å‘ˆç°åˆ°å±å¹•ä¸Šçš„æ—¶é—´|domæ„å»ºå®Œæˆ|onLoad äº‹ä»¶è§¦å‘çš„æ—¶é—´|

## çœŸæ­£è¡¡é‡webæ€§èƒ½çš„æŒ‡æ ‡åŠè®¡ç®—
é¦–å±æ—¶é—´ First Screen Paintï¼ˆFSPï¼‰  

é¡µé¢ä»å¼€å§‹åŠ è½½åˆ°é¦–å±å†…å®¹å…¨éƒ¨ç»˜åˆ¶å®Œæˆçš„æ—¶é—´ï¼Œç”¨æˆ·å¯ä»¥çœ‹åˆ°é¦–å±çš„å…¨éƒ¨å†…å®¹ã€‚
![avatar](img/æ€§èƒ½htmlè¿‡ç¨‹.png)
æ²¡æœ‰å…·ä½“çš„è®¡ç®—æ–¹æ³•ï¼Œä»¥onloadï¼ŸLoadæ—¶é—´å¤ªé•¿ï¼Œç”¨æˆ·éƒ½å¯ä»¥äº¤äº’äº†ã€‚

3ä¸ªæ ¸å¿ƒæŒ‡æ ‡ï¼šFPã€FSPã€TTI

```
ä¸€äº›æ ¸å¿ƒæ—¶é—´å¯ä»¥é€šè¿‡ä»¥ä¸‹æ—¶é—´ç‚¹è¿›è¡Œè®¡ç®—ï¼š(performance.timing)

DNSæŸ¥è¯¢ï¼šdomainLookupEnd - domainLookupStartï¼ˆkeeper-0msï¼‰
TCPè¿æ¥ï¼šconnectEnd - connectStart(0ï¼‰

FPé¦–æ¬¡æ¸²æŸ“ï¼šdomLoading - navigationStart (ç™½å±æ—¶é—´-97)
FSPï¼šå¯è§†åŒºåŸŸå†…å®Œæ•´çš„å†…å®¹ (æš‚æ—¶æ²¡æœ‰æ ‡å‡†)
TTIï¼šå¯æµç•…äº¤äº’æ—¶é—´ï¼šdomInteractive - navigationStart  (338)
DOMReadyï¼šdomContentLoadedEventEnd - navigationStart ï¼ˆ439ï¼‰
onloadï¼šloadEventEnd - navigationStartï¼ˆ446ï¼‰

è§£é‡Šï¼š
navigationStart åŠ è½½èµ·å§‹æ—¶é—´

```
ğŸŒ°ä¾‹å­
```
<!DOCTYPE html>
<html>
  <head>
    <title>Critical Path: Measure</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link href="style.css" rel="stylesheet">
    <script>
      function measureCRP() {
        var t = window.performance.timing,
          interactive = t.domInteractive - t.domLoading,
          dcl = t.domContentLoadedEventStart - t.domLoading,
          complete = t.domComplete - t.domLoading;
        var stats = document.createElement('p');
        stats.textContent = 'interactive: ' + interactive + 'ms, ' +
            'dcl: ' + dcl + 'ms, complete: ' + complete + 'ms';
        document.body.appendChild(stats);
      }
    </script>
  </head>
  <body onload="measureCRP()">
    <p>Hello <span>web performance</span> students!</p>
    <div><img src="awesome-photo.jpg"></div>
  </body>
</html>
```

## é™„

Frames Per Secondï¼ˆFPSï¼‰

`å¸§ç‡`æ˜¯è§†é¢‘è®¾å¤‡äº§ç”Ÿå›¾åƒï¼ˆæˆ–å¸§ï¼‰çš„é€Ÿç‡ï¼Œç”¨æ¯ç§’å¯ä»¥é‡æ–°ç»˜åˆ¶çš„å¸§æ•°ï¼ˆFrames Per Secondï¼ŒFPSï¼‰è¡¨ç¤ºã€‚
é‡æ–°ç»˜åˆ¶å¯èƒ½éœ€è¦é‡æ–°è®¡ç®—æ ·å¼ã€å¸ƒå±€å’Œç»˜åˆ¶ï¼Œå¦‚æœæ¯å¸§ç»˜åˆ¶åˆ°å±å¹•çš„æ—¶é—´åœ¨ 16.7 ms ä»¥ä¸Šï¼Œæ¯ç§’ç»˜åˆ¶çš„å¸§æ•°å°±ä¼šå°äº 60 å¸§ï¼Œäººçœ¼å°±èƒ½æ„Ÿå—åˆ°é¡µé¢å‡ºç°å¡é¡¿ï¼Œæ‰€ä»¥Â FPS æ˜¯è¡¡é‡åº”ç”¨æµç•…åº¦çš„ä¸€ä¸ªéå¸¸é‡è¦çš„æŒ‡æ ‡ï¼Œ60fps æ˜¯é¡µé¢æµç•…çš„ç›®æ ‡ï¼Œå¯ä»¥ä¸ºæ¯æ¬¡ç»˜åˆ¶æä¾› 16.7ms çš„æ—¶é—´é¢„ç®—ã€‚

## å‚è€ƒ
https://my.oschina.net/u/3247020/blog/4361819  
https://juejin.cn/post/6844904153869713416#heading-6  
https://developers.google.com/web/fundamentals/performance/critical-rendering-path/measure-crp?hl=zh-cn   


